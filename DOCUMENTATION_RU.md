# Gibbed.MadMax — Документация проекта

## Оглавление

1. [Обзор проекта](#обзор-проекта)
2. [Архитектура](#архитектура)
3. [Структура решения](#структура-решения)
4. [Библиотеки](#библиотеки)
   - [Gibbed.IO](#gibbedio)
   - [Gibbed.MadMax.FileFormats](#gibbedmadmaxfileformats)
   - [Gibbed.MadMax.PropertyFormats](#gibbedmadmaxpropertyformats)
   - [Gibbed.ProjectData](#gibbedprojectdata)
   - [NDesk.Options](#ndeskoptions)
5. [Форматы файлов игры](#форматы-файлов-игры)
   - [ADF — Arbitrary Data Format](#adf--arbitrary-data-format)
   - [TAB/ARC — Большие архивы](#tabarc--большие-архивы)
   - [SARC — Малые архивы](#sarc--малые-архивы)
   - [RTPC/BIN — Контейнеры свойств](#rtpcbin--контейнеры-свойств)
   - [XVMC — Скриптовые модули XVM](#xvmc--скриптовые-модули-xvm)
6. [Утилиты командной строки](#утилиты-командной-строки)
   - [Gibbed.MadMax.Unpack](#gibbedmadmaxunpack)
   - [Gibbed.MadMax.SmallUnpack](#gibbedmadmaxsmallunpack)
   - [Gibbed.MadMax.SmallPack](#gibbedmadmaxsmallpack)
   - [Gibbed.MadMax.ConvertAdf](#gibbedmadmaxconvertadf)
   - [Gibbed.MadMax.ConvertProperty](#gibbedmadmaxconvertproperty)
   - [Gibbed.MadMax.ConvertSpreadsheet](#gibbedmadmaxconvertspreadsheet)
   - [Gibbed.MadMax.XvmDisassemble](#gibbedmadmaxxvmdisassemble)
   - [RebuildFileLists](#rebuildfilelists)
7. [GUI-приложение — ArchiveViewer](#gui-приложение--archiveviewer)
8. [Система скриптов XVM](#система-скриптов-xvm)
   - [Набор опкодов](#набор-опкодов)
   - [Формат инструкций](#формат-инструкций)
   - [Структура модуля XvmModule](#структура-модуля-xvmmodule)
   - [Система констант](#система-констант)
   - [Нативные модули](#нативные-модули)
9. [Система типов ADF](#система-типов-adf)
10. [Система хеширования](#система-хеширования)
11. [Сборка проекта](#сборка-проекта)
12. [Лицензия](#лицензия)

---

## Обзор проекта

**Gibbed.MadMax** — набор инструментов на C# для работы с файлами игры Mad Max (2015, Avalanche Studios). Проект позволяет:

- Распаковывать игровые архивы (`.tab`/`.arc` и `.sarc`)
- Конвертировать бинарные данные (ADF, свойства) в XML и обратно
- Дизассемблировать скриптовый байткод XVM
- Просматривать содержимое архивов через графический интерфейс
- Упаковывать файлы обратно в архивы `.sarc`

Игра Mad Max построена на движке **Apex Engine** от Avalanche Studios и использует собственные форматы данных для хранения ресурсов, конфигурации и скриптов.

**Автор**: Rick (rick 'at' gibbed 'dot' us)
**Участники**: Rick, Sir Kane, SK83RJOSH
**Лицензия**: BSD 3-Clause
**Платформа**: .NET Framework 4.8

---

## Архитектура

Проект организован по принципу многослойной архитектуры:

```
┌──────────────────────────────────────────────────────┐
│          Утилиты (Unpack, ConvertAdf, и др.)         │  ← CLI-инструменты
├──────────────────────────────────────────────────────┤
│         Gibbed.MadMax.PropertyFormats                │  ← Свойства (RTPC/BIN)
├──────────────────────────────────────────────────────┤
│         Gibbed.MadMax.FileFormats                    │  ← Форматы (ADF, TAB, SARC, XVM)
├────────────────────────┬─────────────────────────────┤
│    Gibbed.ProjectData  │       NDesk.Options         │  ← Управление проектом / CLI-парсинг
├────────────────────────┴─────────────────────────────┤
│                    Gibbed.IO                         │  ← Бинарный I/O
└──────────────────────────────────────────────────────┘
```

Каждый слой зависит только от нижележащих. Утилиты командной строки используют все слои, обеспечивая полный цикл работы с файлами игры.

---

## Структура решения

Файл решения: `Mad Max.sln` (Visual Studio 2022)

### Библиотеки (Class Library)

| Проект | Описание | Целевая платформа |
|--------|----------|-------------------|
| `Gibbed.IO` | Бинарный ввод/вывод, работа с потоками | .NET Standard 2.0+ |
| `Gibbed.ProjectData` | Управление проектами, хеш-листы | .NET Framework 4.8 |
| `Gibbed.MadMax.FileFormats` | Парсеры форматов файлов (ADF, TAB, SARC, XVM) | .NET Framework 4.8 |
| `Gibbed.MadMax.PropertyFormats` | Форматы контейнеров свойств (RTPC, BIN) | .NET Framework 4.8 |
| `NDesk.Options` | Парсинг аргументов командной строки | .NET Standard 2.0+ |

### Консольные утилиты (Console Application)

| Проект | Описание |
|--------|----------|
| `Gibbed.MadMax.Unpack` | Распаковка больших архивов `.tab` |
| `Gibbed.MadMax.SmallUnpack` | Распаковка малых архивов `.sarc` |
| `Gibbed.MadMax.SmallPack` | Упаковка файлов в `.sarc` |
| `Gibbed.MadMax.ConvertAdf` | Конвертация ADF (бинарный <-> XML) |
| `Gibbed.MadMax.ConvertProperty` | Конвертация контейнеров свойств (бинарный <-> XML) |
| `Gibbed.MadMax.ConvertSpreadsheet` | Конвертация таблиц |
| `Gibbed.MadMax.XvmDisassemble` | Дизассемблирование байткода XVM |
| `RebuildFileLists` | Перестроение хеш-листов файлов |

### GUI-приложение

| Проект | Описание |
|--------|----------|
| `Gibbed.Avalanche.ArchiveViewer` | Просмотрщик архивов (Windows Forms) |

### Внешние зависимости

| Библиотека | Версия | Назначение |
|------------|--------|------------|
| `ICSharpCode.SharpZipLib.dll` | 0.85.5 | ZIP-сжатие/распаковка (Deflate) |

---

## Библиотеки

### Gibbed.IO

Базовая библиотека для бинарного ввода/вывода. Предоставляет набор extension-методов для `Stream`, обеспечивающих удобное чтение и запись данных с учётом порядка байтов.

**Основные возможности:**

- **Endian** — перечисление порядка байтов (`Little`, `Big`)
- **StreamHelpers** — расширения для `Stream`:
  - `ReadValueU8/S8/U16/S16/U32/S32/U64/S64/F32/F64` — чтение примитивных типов
  - `WriteValueU8/U16/U32/U64/F32/F64` — запись примитивных типов
  - `ReadString/ReadStringZ` — чтение строк (ASCII/UTF-8, null-terminated)
  - `WriteString/WriteStringZ` — запись строк
  - `ReadToMemoryStream` — чтение блока данных в MemoryStream
  - `WriteFromStream` — копирование данных между потоками
- **PathHelper** — утилиты для работы с путями
- **NumberHelpers** — числовые преобразования, выравнивание (`Align`)
- **OverlapSingle/OverlapDouble** — union-типы для type punning (конвертация float <-> uint и т.д.)

### Gibbed.MadMax.FileFormats

Библиотека парсеров игровых форматов. Содержит:

- **AdfFile** — парсер Arbitrary Data Format (ADF)
- **ArchiveTableFile** — парсер таблиц больших архивов (`.tab`)
- **SmallArchiveFile** — парсер малых архивов (`.sarc`)
- **XvmModule** — парсер скриптовых модулей XVM
- **XvmOpcode** — перечисление опкодов виртуальной машины XVM
- **FileDetection** — определение типа файла по magic-числу
- Вспомогательные типы: `Vector2`, `Vector3`, `Vector4`, `Matrix3x4`, `Matrix4x4`

### Gibbed.MadMax.PropertyFormats

Библиотека для работы с контейнерами свойств (RTPC/BIN). Свойства используются игрой для хранения конфигурации объектов.

**Ключевые типы:**

- **IPropertyFile** — интерфейс файла свойств
- **PropertyContainerFile** — формат RTPC (Runtime Property Container)
- **RawPropertyContainerFile** — «сырой» бинарный формат свойств
- **Node** — узел дерева свойств, содержит дочерние узлы и свойства
- **IVariant** — базовый интерфейс значения свойства
- **Типы значений (Variant)**:
  - `StringVariant` — строка
  - `IntegerVariant` / `IntegersVariant` — целое число / массив целых
  - `FloatVariant` / `FloatsVariant` — число с плавающей точкой / массив
  - `BytesVariant` — массив байтов
  - `ObjectIdVariant` — идентификатор объекта
  - `Vector2Variant` / `Vector3Variant` / `Vector4Variant` — 2D/3D/4D векторы
  - `Matrix3x4Variant` / `Matrix4x4Variant` — матрицы
  - `EventsVariant` — списки событий

### Gibbed.ProjectData

Управление метаданными проекта — хеш-листы, конфигурация, обнаружение установки игры.

- **Manager** — синглтон, загружает и управляет определениями проекта
- **Project** — определение игрового проекта (имя, пути, зависимости)
- **HashList<T>** — маппинг хешей в имена с кешированием

### NDesk.Options

Библиотека разбора аргументов командной строки в стиле GNU `getopt_long`. Используется всеми CLI-утилитами для обработки флагов и параметров.

---

## Форматы файлов игры

### ADF — Arbitrary Data Format

Универсальный контейнер структурированных данных. Используется для хранения данных произвольных типов: от игровых скриптов до конфигурации уровней.

**Сигнатура**: `0x41444620` (`'ADF '`)
**Версия**: 4
**Порядок байтов**: определяется по magic-числу (little-endian или big-endian)

**Структура заголовка:**

| Смещение | Размер | Поле |
|----------|--------|------|
| 0x00 | 4 | Magic (`ADF `) |
| 0x04 | 4 | Версия (4) |
| 0x08 | 4 | Количество экземпляров (instances) |
| 0x0C | 4 | Смещение таблицы экземпляров |
| 0x10 | 4 | Количество определений типов |
| 0x14 | 4 | Смещение таблицы определений типов |
| 0x18 | 4 | Количество неизвестных (должно быть 0) |
| 0x1C | 4 | Смещение неизвестных |
| 0x20 | 4 | Количество имён в таблице |
| 0x24 | 4 | Смещение таблицы имён |
| 0x28 | 4 | Общий размер файла |
| 0x2C | 20 | Зарезервировано (нули) |
| 0x40 | var | Комментарий (null-terminated ASCII) |

**Система типов ADF:**

```
TypeDefinitionType:
  Primitive    = 0   — примитивный тип
  Structure    = 1   — структура с полями
  Pointer      = 2   — указатель
  Array        = 3   — динамический массив
  InlineArray  = 4   — встроенный массив (фиксированный размер)
  String       = 5   — строка
  BitField     = 7   — битовое поле
  Enumeration  = 8   — перечисление
  StringHash   = 9   — хеш строки
```

**Хеши примитивных типов:**

| Тип | Хеш | Описание |
|-----|------|----------|
| `uint8` | `0x0CA2821D` | Беззнаковое 8-бит |
| `int8` | `0x580D0A62` | Знаковое 8-бит |
| `uint16` | `0x86D152BD` | Беззнаковое 16-бит |
| `int16` | `0xD13FCF93` | Знаковое 16-бит |
| `uint32` | `0x075E4E4F` | Беззнаковое 32-бит |
| `int32` | `0x192FE633` | Знаковое 32-бит |
| `uint64` | `0xA139E01F` | Беззнаковое 64-бит |
| `int64` | `0xAF41354F` | Знаковое 64-бит |
| `float` | `0x7515A207` | Число с плав. точкой 32-бит |
| `double` | `0xC609F663` | Число с плав. точкой 64-бит |
| `String` | `0x8955583E` | Строка |

**Экземпляр (InstanceInfo):**

Каждый экземпляр данных описывается записью:
- `NameHash` (4 байта) — хеш имени
- `TypeHash` (4 байта) — хеш типа данных
- `Offset` (4 байта) — смещение данных в файле
- `Size` (4 байта) — размер данных
- `Name` — имя (через индекс в таблице имён)

**Конвертация:** ADF экспортируется в XML, где структуры представлены как вложенные XML-элементы. Импорт из XML обратно в бинарный формат пока не реализован (`NotImplementedException`).

### TAB/ARC — Большие архивы

Основной формат хранения игровых ресурсов. Состоит из пары файлов:
- `.tab` — таблица индексов (метаданные)
- `.arc` — данные файлов

**Формат TAB:**

Начинается с magic-числа `0x0800`, которое одновременно задаёт выравнивание и определяет порядок байтов.

Содержит два раздела:

1. **Списки чанков** (для файлов, разбитых на блоки со сжатием):
   - Хеш имени файла
   - Количество чанков
   - Для каждого чанка: смещение несжатых и сжатых данных

2. **Записи файлов**:
   - Хеш имени файла (uint32)
   - Смещение в `.arc` (uint32)
   - Размер сжатых данных (uint32)
   - Размер несжатых данных (uint32)

**Сжатие**: Deflate (raw, без заголовков zlib). Если `CompressedSize == UncompressedSize`, данные хранятся без сжатия.

**Файлы с чанками**: крупные файлы разбиваются на блоки, каждый из которых сжимается отдельно. Это позволяет осуществлять частичное чтение без распаковки всего файла.

### SARC — Малые архивы

Простые архивы без сжатия для хранения небольших групп файлов.

**Формат:**

| Смещение | Размер | Поле |
|----------|--------|------|
| 0x00 | 4 | Размер заголовка (4) |
| 0x04 | 4 | Magic (`SARC`) |
| 0x08 | 4 | Версия (2) |
| 0x0C | 4 | Размер индекса |
| 0x10 | var | Индексные записи |

**Запись индекса:**
- Длина имени файла (uint32)
- Имя файла (ASCII, выровненное до 4 байт)
- Смещение данных (uint32)
- Размер данных (uint32)

Максимальная длина имени файла: 256 символов.

Формат SARC поддерживает как чтение, так и запись — можно как распаковывать, так и создавать архивы.

### RTPC/BIN — Контейнеры свойств

Иерархические контейнеры для хранения свойств игровых объектов. Используются для настройки поведения транспортных средств, персонажей, интерфейса и т.д.

**Сигнатура RTPC**: `0x43505452` (`'RTPC'`)
**Сигнатура BIN**: `01 04 00`

Данные организованы в виде дерева узлов (`Node`), каждый из которых может содержать:
- Дочерние узлы
- Свойства с типизированными значениями (Variant)

Конвертер поддерживает обе стороны (экспорт в XML и импорт из XML), а также выбор порядка байтов (little-endian / big-endian).

### XVMC — Скриптовые модули XVM

Файлы `.xvmc` содержат скомпилированный байткод скриптовой VM (XVM), обёрнутый в ADF-контейнер.

Внутри ADF хранятся два экземпляра:
- `"module"` — основной модуль XVM (тип `0x41D02347`)
- `"debug_strings"` (необязательно, тип `0xFEF3B589`) — отладочные строки

Подробнее о формате — в разделе [Система скриптов XVM](#система-скриптов-xvm).

---

## Утилиты командной строки

### Gibbed.MadMax.Unpack

Распаковка больших игровых архивов (`.tab` + `.arc`).

```
Gibbed.MadMax.Unpack [OPTIONS]+ input_tab [output_dir]

Опции:
  -o, --overwrite         Перезаписывать существующие файлы
  -nu, --no-unknowns      Не извлекать файлы с неизвестными именами
  -f, --filter=PATTERN    Регулярное выражение для фильтрации
  -v, --verbose           Подробный вывод
  -p, --project=NAME      Указать проект
  -h, --help              Справка
```

**Логика работы:**
1. Загружает хеш-листы имён файлов из данных проекта
2. Считывает таблицу `.tab`
3. Открывает файл данных `.arc`
4. Для каждой записи:
   - Ищет имя по хешу в хеш-листах
   - Если имя не найдено — определяет тип файла по magic-числу и помещает в `__UNKNOWN/{расширение}/`
   - Если имя найдено, но путь не определён — помещает в `__UNSORTED/`
   - Распаковывает данные (Deflate), если они сжаты
   - Поддерживает файлы с чанками

### Gibbed.MadMax.SmallUnpack

Распаковка малых архивов `.sarc`.

```
Gibbed.MadMax.SmallUnpack [OPTIONS]+ input_sarc [output_dir]

Опции:
  -v, --verbose      Выводить список извлекаемых файлов
  -l, --list         Только показать содержимое (без извлечения)
  -o, --overwrite    Перезаписывать существующие файлы
  -f, --full-path    Использовать полные пути из архива
  -h, --help         Справка
```

### Gibbed.MadMax.SmallPack

Упаковка файлов в архив `.sarc` (обратная операция к SmallUnpack).

### Gibbed.MadMax.ConvertAdf

Конвертация файлов ADF между бинарным и XML форматами.

```
Gibbed.MadMax.ConvertAdf [OPTIONS]+ input_file [output_file]

Опции:
  -e, --export             Бинарный -> XML
  -i, --import             XML -> бинарный
  -t, --type-library=FILE  Загрузить библиотеку типов из ADF-файла
  -h, --help               Справка
```

**Особенности:**
- Режим определяется автоматически по расширению: `.xml` = импорт, иное = экспорт
- Поддерживает внешние библиотеки типов (флаг `-t`): позволяет загрузить определения типов из отдельного ADF-файла, необходимого для корректной интерпретации данных
- Экспорт: экземпляры данных сериализуются в XML с рекурсивным обходом типов (структуры, массивы, перечисления)
- Импорт: пока не реализован (`NotImplementedException`)

**Поддерживаемые типы при экспорте:**
- Все примитивные типы (uint8 — double, String)
- Структуры (с рекурсивным обходом полей)
- Массивы (динамические и inline)
- Перечисления
- Указатели и битовые поля (выводятся как заглушки)

### Gibbed.MadMax.ConvertProperty

Конвертация контейнеров свойств между бинарным и XML форматами.

```
Gibbed.MadMax.ConvertProperty [OPTIONS]+ input_file [output_file]

Опции:
  -e, --export           Бинарный -> XML
  -i, --import           XML -> бинарный
  -l, --little-endian    Вывод в little-endian
  -b, --big-endian       Вывод в big-endian
  -p, --project=NAME     Указать проект
  -h, --help             Справка
```

### Gibbed.MadMax.ConvertSpreadsheet

Конвертация табличных данных.

### Gibbed.MadMax.XvmDisassemble

Дизассемблирование скриптовых модулей XVM.

```
Gibbed.MadMax.XvmDisassemble [OPTIONS]+ input_xvmc [output_dis]

Опции:
  -h, --help    Справка
```

**Формат вывода:**

Для каждой функции в модуле создаётся секция:

```
== ИмяФункции ==
    ldloc 0
    ldattr "speed"
    ldfloat 100.0
    cmpg
    jz label_5
    ldglob "gui"
    ldstr "BOOST!"
    call 1
label_5:
    ldnone
    ret 1
```

Дизассемблер:
- Автоматически определяет и расставляет метки для инструкций перехода (`jmp`, `jz`)
- Декодирует строковые константы (из StringBuffer или debug_strings)
- При отсутствии отладочных строк — выводит хеши
- Поддерживает все 32 опкода XVM

### RebuildFileLists

Утилита для пересоздания хеш-листов файлов. Используется для обновления маппинга хешей имён файлов, что необходимо утилите распаковки (Unpack) для определения имён файлов в архивах.

---

## GUI-приложение — ArchiveViewer

`Gibbed.Avalanche.ArchiveViewer` — приложение Windows Forms для интерактивного просмотра содержимого игровых архивов.

**Возможности:**
- Открытие и навигация по архивам
- Просмотр структуры файлов
- Извлечение отдельных файлов
- Перезагрузка списков файлов
- Настройки

Требует Windows (Windows Forms).

---

## Система скриптов XVM

Mad Max использует скриптовую виртуальную машину **XVM** (часть Apex Engine). Скрипты компилируются в байткод и хранятся в файлах `.xvmc`, обёрнутых в ADF-контейнер.

### Структура модуля XvmModule

Модуль XVM описывается структурой `XvmModule` (тип `0x41D02347`):

| Поле | Тип | Описание |
|------|-----|----------|
| `NameHash` | uint32 | Хеш имени модуля |
| `SourceHash` | uint32 | Хеш исходного кода |
| `Flags` | uint32 | Флаги модуля |
| `ModuleSize` | uint32 | Размер модуля |
| `DebugInfoArray` | int64 | Указатель на отладочную информацию |
| `ThisInstance` | uint64 | Указатель на экземпляр |
| `ThisType` | uint64 | Указатель на тип |
| `Functions` | массив | Функции модуля |
| `ImportHashes` | uint32[] | Хеши импортируемых символов |
| `Constants` | массив | Пул констант |
| `StringHashes` | uint32[] | Хеши строк |
| `StringBuffer` | byte[] | Буфер строковых данных |
| `Name` | string | Имя модуля |

### Функции

Каждая функция описывается структурой `Function`:

| Поле | Тип | Описание |
|------|-----|----------|
| `NameHash` | uint32 | Хеш имени функции |
| `LocalsCount` | uint16 | Количество локальных переменных |
| `ArgCount` | uint16 | Количество аргументов |
| `Instructions` | uint16[] | Массив инструкций (байткод) |
| `MaxStackDepth` | uint16 | Максимальная глубина стека |
| `Module` | uint64 | Ссылка на модуль |
| `LinenoPtr` | int64 | Указатель на информацию о строках |
| `ColnoPtr` | int64 | Указатель на информацию о столбцах |
| `Name` | string | Имя функции |

### Формат инструкций

Каждая инструкция занимает **16 бит** и кодируется как:

```
[15..5] операнд (11 бит)
[4..0]  опкод   (5 бит)

opcode  = instruction & 0x1F
operand = instruction >> 5
```

### Набор опкодов

Полный перечень опкодов XVM (всего 32 позиции, из которых 30 определены):

| Код | Имя | Мнемоника | Описание |
|-----|-----|-----------|----------|
| 0 | Assert | `assert` | Проверка значения (не-null/не-zero) |
| 1 | And | `and` | Логическое И |
| 2 | Or | `or` | Логическое ИЛИ |
| 3 | Add | `add` | Сложение (float) |
| 4 | Div | `div` | Деление (float) |
| 5 | Mod | `mod` | Остаток от деления (fmodf) |
| 6 | Mul | `mul` | Умножение (float) |
| 7 | Sub | `sub` | Вычитание (float) |
| 8 | MakeList | `mklist N` | Создать список из N элементов стека |
| 9 | Call | `call N` | Вызов функции с N аргументами |
| 10 | CmpEq | `cmpeq` | Сравнение: == |
| 11 | CmpGe | `cmpge` | Сравнение: >= |
| 12 | CmpG | `cmpg` | Сравнение: > |
| 13 | CmpNe | `cmpne` | Сравнение: != |
| 14 | Jmp | `jmp addr` | Безусловный переход |
| 15 | Jz | `jz addr` | Переход при zero/false/none |
| 16-17 | — | — | Не определены |
| 18 | LoadAttr | `ldattr "name"` | Загрузить атрибут объекта |
| 19 | LoadConst | `ldnone/ldfloat/ldstr` | Загрузить константу |
| 20 | LoadBool | `ldbool 0/1` | Загрузить булево значение |
| 21 | LoadGlobal | `ldglob "name"` | Загрузить глобальный модуль |
| 22 | LoadLocal | `ldloc N` | Загрузить локальную переменную |
| 23 | LoadItem | `lditem` | Загрузить элемент списка (list[index]) |
| 24 | Pop | `pop` | Удалить верхний элемент стека |
| 25 | DebugOut | `dbgout N` | Отладочный вывод |
| 26 | Ret | `ret N` | Возврат (0=без значения, 1=с значением) |
| 27 | StoreAttr | `stattr "name"` | Сохранить атрибут объекта |
| 28 | StoreLocal | `stloc N` | Сохранить в локальную переменную |
| 29 | StoreItem | `stitem` | Сохранить элемент списка (list[index] = value) |
| 30 | Not | `not` | Логическое отрицание |
| 31 | Neg | `neg` | Арифметическое отрицание |

**Классификация опкодов:**

- **Арифметика** (0x03-0x07): все операции работают с float
- **Логика** (0x00-0x02, 0x1E): assert, and, or, not
- **Сравнения** (0x0A-0x0D): результат — булево значение
- **Управление потоком** (0x0E-0x0F, 0x1A): jmp, jz, ret
- **Загрузка** (0x12-0x17): чтение из различных источников
- **Сохранение** (0x1B-0x1D): запись в различные назначения
- **Стек** (0x08, 0x18): mklist, pop
- **Вызовы** (0x09): call
- **Отладка** (0x19): dbgout

### Система констант

Каждая константа занимает 16 байт:

| Поле | Тип | Описание |
|------|-----|----------|
| `Flags` | uint64 | Флаги и метаданные |
| `Value` | uint64 | Значение или смещение |

Из `Flags` извлекается:
- `Length` (биты 0-7) — длина строковых данных
- `AllocatedLength` (биты 8-15) — выделенная длина
- `Type` (биты 16-19) — тип константы:
  - `0` — none (nil)
  - `3` — float (биты значения в `Value`)
  - `4` — string (смещение в `StringBuffer`)

**Строки в StringBuffer:**

Для строковых констант (тип 4):
- `StringBuffer[Value .. Value+Length]` — сама строка
- `StringBuffer[Value-3]` — индекс в массиве `StringHashes`
- `StringBuffer[Value-2:Value-1]` — смещение в debug_strings (big-endian, если доступны)

### Нативные модули

Игра регистрирует нативные C-модули, доступные из скриптов. Они загружаются через опкод `LoadGlobal` по имени модуля.

Основные модули:

| Модуль | Назначение | Примеры функций |
|--------|------------|-----------------|
| `gui` | Интерфейс | ShowMessage, PostEvent, SendGuiMessage |
| `model` | 3D-модели | SetOutlineColor, SetOutlineVisible |
| `vehicle` | Транспорт | SetSpeed, GetPosition |
| `character` | Персонажи | PlayAnimation, IsWithinSegment |
| `game` | Геймплей | FindClosestLocation, SpawnEffect |
| `camera` | Камера | SetFOV, Shake |
| `animation` | Анимация | Play, Stop, Blend |
| `ai` | ИИ | SetBehavior |
| `physics` | Физика | RayCast, ApplyForce |

Функции вызываются через опкод `call N`, где на стеке находятся объект модуля и аргументы.

---

## Система типов ADF

Система типов ADF описывает структуры данных, используемые в файлах игры. Каждый тип определяется следующими полями:

- **Type** — категория типа (Structure, Array, Enumeration и др.)
- **Size** — размер в байтах
- **Alignment** — выравнивание
- **NameHash** — хеш имени типа
- **Name** — имя типа (через таблицу имён)
- **Flags** — дополнительные флаги
- **ElementTypeHash** — хеш типа элемента (для массивов)
- **ElementLength** — количество элементов (для inline-массивов)
- **Members** — поля структуры или значения перечисления

**Определение поля (MemberDefinition):**

| Поле | Описание |
|------|----------|
| `Name` | Имя поля |
| `TypeHash` | Хеш типа поля |
| `Size` | Размер поля |
| `Offset` | Смещение от начала структуры |

Библиотека типов может быть загружена из внешнего ADF-файла (флаг `-t` в ConvertAdf). Это позволяет обрабатывать данные, типы которых определены в другом файле.

---

## Система хеширования

Имена файлов и строковых констант хранятся в виде 32-битных хешей. Алгоритм хеширования:

```
hash = 0
для каждого символа c в строке:
    hash = hash * 31 + (unsigned byte)c
```

**Хеш-листы** — файлы, содержащие маппинг хешей в оригинальные имена. Используются утилитой `Unpack` для восстановления имён файлов при извлечении из архивов. Файлы, для которых имя не найдено в хеш-листах, помещаются в каталог `__UNKNOWN/` с именем в виде хеша и расширением, определённым по magic-числу.

**Определение типа файла по magic-числу (`FileDetection`):**

| Magic | Расширение | Тип |
|-------|------------|-----|
| `0x20534444` | `.dds` | Текстура (DDS) |
| `0x41444620` | `.adf` | Arbitrary Data Format |
| `0x43505452` | `.rtpc` | Property Container |
| `0x57E0E057` | `.ban` | Анимация |
| `0x35425346` | `.fsb5` | Аудио (FMOD Sound Bank) |
| `0x0E00000030000000` | `.btc` | ИИ-данные |
| `01 04 00` | `.bin` | Бинарные свойства |

---

## Сборка проекта

### Требования

- Visual Studio 2022 (или совместимая среда)
- .NET Framework 4.8 SDK
- .NET Standard 2.0 SDK (для Gibbed.IO и NDesk.Options)

### Конфигурации сборки

| Конфигурация | Платформа | Оптимизация | Символы |
|--------------|-----------|-------------|---------|
| Debug | AnyCPU / x86 | Нет | Полные |
| Release | AnyCPU / x86 | Да | PDB-only |

### Сборка

```
# Через Visual Studio
Открыть "Mad Max.sln" → Сборка → Собрать решение

# Через командную строку
msbuild "Mad Max.sln" /p:Configuration=Release
```

### Выходные файлы

Все скомпилированные файлы помещаются в каталог `bin/`:

**Исполняемые файлы:**
- `Gibbed.MadMax.Unpack.exe`
- `Gibbed.MadMax.SmallUnpack.exe`
- `Gibbed.MadMax.SmallPack.exe`
- `Gibbed.MadMax.ConvertAdf.exe`
- `Gibbed.MadMax.ConvertProperty.exe`
- `Gibbed.MadMax.ConvertSpreadsheet.exe`
- `Gibbed.MadMax.XvmDisassemble.exe`
- `RebuildFileLists.exe`
- `Gibbed.MadMax.ArchiveViewer.exe`

**Библиотеки:**
- `Gibbed.IO.dll`
- `Gibbed.MadMax.FileFormats.dll`
- `Gibbed.MadMax.PropertyFormats.dll`
- `Gibbed.ProjectData.dll`
- `NDesk.Options.dll`
- `ICSharpCode.SharpZipLib.dll`

---

## Лицензия

Проект распространяется под лицензией **BSD 3-Clause** (Simplified BSD License).

- Разрешено коммерческое использование
- Разрешена модификация исходного кода
- Требуется указание авторства в документации
- Авторы не несут ответственности за ущерб

Copyright (c) 2015, Rick (rick 'at' gibbed 'dot' us)
